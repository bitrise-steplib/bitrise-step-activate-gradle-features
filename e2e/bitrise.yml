format_version: "11"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

app:
  envs:
  - TEST_APP_URL: https://github.com/bitrise-io/Bitrise-Android-Sample
  - BRANCH: main

workflows:
  test_disable_all:
    envs:
    - BUILD_CACHE_ENABLED: "false"
    - BUILD_CACHE_PUSH: "false"
    - BUILD_CACHE_VALIDATION_LEVEL: none
    - TEST_DISTRIBUTION_ENABLED: "false"
    - TEST_DISTRIBUTION_SHARD_SIZE: "50"
    - VERBOSE: "true"
    - BITRISE_ANALYTICS_DISABLED: "true"
    after_run:
    - bundle::setup: { }
    - bundle::run: { }
    - bundle::check: { }

  test_analytics:
    envs:
    - BUILD_CACHE_ENABLED: "false"
    - BUILD_CACHE_PUSH: "false"
    - BUILD_CACHE_VALIDATION_LEVEL: none
    - TEST_DISTRIBUTION_ENABLED: "false"
    - TEST_DISTRIBUTION_SHARD_SIZE: "50"
    - VERBOSE: "true"
    after_run:
    - bundle::setup: { }
    - bundle::run: { }
    - bundle::check: { }

  test_cache:
    envs:
    - BUILD_CACHE_ENABLED: "true"
    - BUILD_CACHE_PUSH: "true"
    - BUILD_CACHE_VALIDATION_LEVEL: warning
    - TEST_DISTRIBUTION_ENABLED: "false"
    - TEST_DISTRIBUTION_SHARD_SIZE: "50"
    - VERBOSE: "true"
    after_run:
    - bundle::setup: { }
    - bundle::run: { }
    - bundle::check: { }

  test_test_distribution:
    envs:
    - BUILD_CACHE_ENABLED: "false"
    - BUILD_CACHE_PUSH: "true"
    - BUILD_CACHE_VALIDATION_LEVEL: warning
    - TEST_DISTRIBUTION_ENABLED: "true"
    - TEST_DISTRIBUTION_SHARD_SIZE: "50"
    - VERBOSE: "true"
    after_run:
    - bundle::setup: { }
    - bundle::run: { }
    - bundle::check: { }

  test_enable_all:
    envs:
    - BUILD_CACHE_ENABLED: "true"
    - BUILD_CACHE_PUSH: "true"
    - BUILD_CACHE_VALIDATION_LEVEL: warning
    - TEST_DISTRIBUTION_ENABLED: "true"
    - TEST_DISTRIBUTION_SHARD_SIZE: "50"
    - VERBOSE: "true"
    after_run:
    - bundle::setup: { }
    - bundle::run: { }
    - bundle::check: { }

step_bundles:
  setup:
    steps:
    - script:
        title: Delete _tmp dir
        inputs:
        - content: rm -rf _tmp
    - git::https://github.com/bitrise-steplib/bitrise-step-simple-git-clone.git:
        inputs:
        - repository_url: $TEST_APP_URL
        - clone_into_dir: ./_tmp
        - branch: $BRANCH

  run:
    steps:
    - path::./:
        title: Execute step
        run_if: "true"
        is_skippable: false
        inputs:
        - build_cache_enabled: $BUILD_CACHE_ENABLED
        - build_cache_push: $BUILD_CACHE_PUSH
        - build_cache_validation_level: $BUILD_CACHE_VALIDATION_LEVEL
        - test_distribution_enabled: $TEST_DISTRIBUTION_ENABLED
        - test_distribution_shard_size: $TEST_DISTRIBUTION_SHARD_SIZE
        - verbose: $VERBOSE
    - change-workdir:
        title: Switch working dir to _tmp
        inputs:
        - path: ./_tmp
    - android-build:
        inputs:
        - module: app
        - variant: debug

  check:
    steps:
    - script:
        title: Check if the step is working
        inputs:
        - content: |-
            #!/bin/bash
            set -ex
            echo "~/.gradle/init.d/bitrise-build-cache.init.gradle.kts content:"
            cat ~/.gradle/init.d/bitrise-build-cache.init.gradle.kts

            ALL_GOOD="true"
            GRADLE_INIT="~/.gradle/init.d/bitrise-build-cache.init.gradle.kts"

            ANALYTICS_LINE="apply<io.bitrise.gradle.analytics.AnalyticsPlugin>()"
            if [ "$BITRISE_ANALYTICS_DISABLED" != "true" ] && [ ! grep -q "$ANALYTICS_LINE" "$GRADLE_INIT" ]
            then
              echo "Analytics were enabled but not found in gradle init"
              ALL_GOOD="false"
            fi

            BUILD_CACHE_LINE="registerBuildCacheService(BitriseBuildCache::class.java, BitriseBuildCacheServiceFactory::class.java)"
            if [ "$BUILD_CACHE_ENABLED" == "true" ] && [ ! grep -q "$BUILD_CACHE_LINE" "$GRADLE_INIT" ]
            then
              echo "Build cache was enabled but not found in gradle init"
              ALL_GOOD="false"
            fi

            TEST_DISTRO_LINE="apply<io.bitrise.gradle.rbe.RBEPlugin>()"
            if [ "$TEST_DISTRIBUTION_ENABLED" == "true" ] && [ ! grep -q "$TEST_DISTRO_LINE" "$GRADLE_INIT" ]
            then
              echo "Test distribution was enabled but not found in gradle init"
              ALL_GOOD="false"
            fi

            if [ "$ALL_GOOD" != "true" ]; then
              exit 1
            fi
